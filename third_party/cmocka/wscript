#!/usr/bin/env python

from waflib import Options

def configure(conf):
    conf.CHECK_FUNCS('strsignal')
    conf.CHECK_FUNCS('longjmp siglongjmp')

    if conf.CHECK_CMOCKA():
        conf.define('USING_SYSTEM_CMOCKA', 1)

def build(bld):
    if bld.CONFIG_SET('USING_SYSTEM_CMOCKA'):
        return

    extra_libs=''

    # Link to librt if needed for clock_gettime()
    if bld.CONFIG_SET('HAVE_LIBRT'): extra_libs += ' rt'

    cmocka_cflags = '-DHAVE_CONFIG_H=1'
    if bld.CONFIG_SET('HAVE_WNO_ERROR_DECLARATION_AFTER_STATEMENT'):
        cmocka_cflags += ' -Wno-error=declaration-after-statement'

    bld.SAMBA_LIBRARY('cmocka',
                      source='cmocka.c',
                      cflags_end=cmocka_cflags,
                      deps=extra_libs,
                      allow_warnings=True,
                      private_library=True)
